<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangul Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hi+Melody&family=Gamja+Flower&family=Gaegu&display=swap" rel="stylesheet">
    <style>
        :root {
            --korean-font: Arial;
            --korean-font-fallback: Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
			overflow-y: scroll; 
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 25px;
            max-width: 500px;
            width: 100%;
        }

        h1 { color: #f5576c; font-size: 22px; flex: 1; }
        .header { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }

        .back-button {
            background: #e9ecef; border: none; border-radius: 8px;
            width: 36px; height: 36px; cursor: pointer; font-size: 16px;
            transition: all 0.3s; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            text-decoration: none; color: #333;
        }
        .back-button:hover { background: #dee2e6; transform: translateX(-3px); }

        .header-buttons { display: flex; gap: 8px; }

        .chart-button, .quiz-button, .font-button {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none; border-radius: 8px; width: 36px; height: 36px;
            cursor: pointer; font-size: 16px; transition: all 0.3s;
            flex-shrink: 0; display: flex; align-items: center;
            justify-content: center; color: white;
        }
        .quiz-button { background: linear-gradient(135deg, #20c997 0%, #12b886 100%); }
        .font-button { background: linear-gradient(135deg, #845ef7 0%, #7950f2 100%); }
        .chart-button:hover, .quiz-button:hover, .font-button:hover { transform: scale(1.1); }

        .level-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .level-btn {
            padding: 10px 8px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; border-radius: 10px;
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;
        }
        .level-btn.active { background: #f5576c; color: white; border-color: #f5576c; }
        .level-btn:hover { transform: translateY(-2px); }

        /* Í∏∞Î≥∏ Í∏ÄÏûê ÏÑ†ÌÉù (2Ï§Ñ) */
        .character-selector { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
            margin-bottom: 10px; 
        }

        .char-btn {
            padding: 8px 4px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; font-size: 20px; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; position: relative; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .char-btn.active { background: #f5576c; color: white; border-color: #f5576c; }
        .char-btn:hover { transform: scale(1.05); }
        .char-btn.has-check::after {
            content: '‚úì'; position: absolute; top: -4px; right: -4px;
            width: 14px; height: 14px; background: #51cf66; border-radius: 50%;
            font-size: 9px; color: white; display: flex; align-items: center; justify-content: center;
        }

        /* ÏÑúÎ∏å Í∏ÄÏûê (ÏåçÏûêÏùå/Ïù¥Ï§ëÎ™®Ïùå) */
        .sub-selector {
            display: flex; justify-content: center; gap: 8px; 
            margin-bottom: 12px; min-height: 44px;
            padding: 8px; background: #f8f9fa; border-radius: 10px;
        }
        .sub-selector:empty { display: none; }
        
        .sub-btn {
            padding: 8px 16px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; font-size: 22px; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
            position: relative;
        }
        .sub-btn.active { background: #ff6b9d; color: white; border-color: #ff6b9d; }
        .sub-btn:hover { transform: scale(1.05); }
        .sub-btn.checked::after {
            content: '‚úì'; position: absolute; top: -4px; right: -4px;
            width: 14px; height: 14px; background: #51cf66; border-radius: 50%;
            font-size: 9px; color: white; display: flex; align-items: center; justify-content: center;
        }

        .character-display { text-align: center; margin-bottom: 12px; }

        .current-character {
            font-size: 65px; color: #f5576c; margin-bottom: 5px; font-weight: bold;
            position: relative; display: inline-block;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .check-mark {
            position: absolute; top: -8px; right: -8px; background: #51cf66;
            color: white; width: 26px; height: 26px; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-size: 16px;
        }
        .check-mark.show { display: flex; }
        .character-info { font-size: 16px; color: #666; }

        .canvas-container {
            position: relative; width: 100%; max-width: 220px;
            margin: 0 auto 12px; aspect-ratio: 1 / 1;
            border-radius: 10px; overflow: hidden;
        }
        canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 3px solid #f5576c; border-radius: 10px; background: white; touch-action: none;
        }
        .guide-canvas { opacity: 0.3; pointer-events: none; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .controls-three { display: grid; grid-template-columns: repeat(3, 1fr); }
        button { padding: 10px 8px; border: none; border-radius: 10px; font-size: 13px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-clear { background: #ff6b9d; color: white; }
        .btn-next { background: #51cf66; color: white; }
        .btn-prev { background: #74c0fc; color: white; }
        .btn-show-guide { background: #ffd43b; color: #333; }
        .btn-check { background: #845ef7; color: white; }
        .btn-check.checked { background: #51cf66; }

        .stroke-order {
            margin-top: 10px; padding: 10px; background: #e7f5ff;
            border-radius: 8px; font-size: 12px; color: #1864ab;
            line-height: 1.5; white-space: pre-line;
			min-height: 69px; /* ‚Üê Ï∂îÍ∞Ä */
        }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 2px solid #f1f3f5;
            position: sticky; top: 0; background: white; z-index: 10; border-radius: 20px 20px 0 0;
        }
        .modal-header h2 { color: #f5576c; font-size: 20px; }
        .modal-close { 
            background: #e9ecef; border: none; border-radius: 50%; 
            width: 32px; height: 32px; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .modal-body { padding: 20px; }

        /* Chart */
        .hangul-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .hangul-table th, .hangul-table td { padding: 10px 6px; text-align: center; border: 1px solid #e9ecef; font-size: 14px; }
        .hangul-table th { background: #f8f9fa; font-weight: bold; color: #495057; }
        .char-main {
            font-size: 22px; font-weight: bold; color: #f5576c;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .section-title { font-size: 16px; font-weight: bold; color: #495057; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #f5576c; }

        /* Font selector */
        .font-selector-modal { max-width: 380px; }
        .font-option {
            padding: 12px; margin: 8px 0; background: #f8f9fa; border: 2px solid transparent;
            border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .font-option:hover { background: #e9ecef; }
        .font-option.active { background: #f5576c; color: white; border-color: #f5576c; }
        .font-option-name { font-weight: bold; margin-bottom: 4px; font-size: 14px; }
        .font-option-preview { font-size: 28px; margin-top: 8px; }

        /* Quiz */
        .quiz-modal-content { width: 420px; max-width: 95vw; }
        .quiz-container { text-align: center; }
        .quiz-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 10px; }
        .quiz-stat { text-align: center; }
        .quiz-stat-label { font-size: 11px; color: #868e96; margin-bottom: 2px; }
        .quiz-stat-value { font-size: 22px; font-weight: bold; }
        .quiz-stat-value.correct { color: #51cf66; }
        .quiz-stat-value.wrong { color: #ff6b9d; }
        .quiz-question { font-size: 42px; color: #495057; margin: 15px 0; font-weight: bold; min-height: 50px; }
        .quiz-answer-area { min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .quiz-answer {
            font-size: 58px; color: #20c997; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .quiz-canvas-container {
            position: relative; width: 100%; max-width: 220px;
            margin: 0 auto 15px; aspect-ratio: 1 / 1; border-radius: 10px; overflow: hidden;
        }
        .quiz-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 3px solid #20c997; border-radius: 10px; background: white; touch-action: none;
        }
        .quiz-guide-canvas { opacity: 0; pointer-events: none; }
        .quiz-buttons { display: flex; gap: 6px; }
		.quiz-btn { flex: 1; }
        .quiz-btn { 
            padding: 10px 6px; background: #20c997; color: white; 
            border: none; border-radius: 10px; cursor: pointer; 
            font-size: 13px; font-weight: bold;
        }
        .quiz-btn-show { background: #845ef7; }

        @media (max-width: 480px) {
            .container { padding: 18px 15px; }
            h1 { font-size: 18px; }
            .current-character { font-size: 55px; }
            .char-btn { font-size: 18px; padding: 6px 2px; }
            .sub-btn { font-size: 20px; padding: 6px 12px; }
            .canvas-container { max-width: 200px; }
            .quiz-canvas-container { max-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="korean-index.html" class="back-button">‚Üê</a>
            <h1>‚úçÔ∏è Hangul Practice</h1>
            <div class="header-buttons">
                <button class="font-button" onclick="openFontSelector()" title="Font">F</button>
                <button class="quiz-button" onclick="openQuiz()" title="Quiz">Q</button>
                <button class="chart-button" onclick="openChart()" title="Chart">Ìëú</button>
            </div>
        </div>

        <div class="level-selector">
            <button class="level-btn active" onclick="selectTab('consonants')">Consonants (ÏûêÏùå)</button>
            <button class="level-btn" onclick="selectTab('vowels')">Vowels (Î™®Ïùå)</button>
        </div>

        <div class="character-selector" id="characterSelector"></div>
        <div class="sub-selector" id="subSelector"></div>

        <div class="character-display">
            <div class="current-character" id="currentCharacter">„Ñ±<span class="check-mark" id="checkMark">‚úì</span></div>
            <div class="character-info" id="characterInfo">g/k</div>
        </div>

        <div class="canvas-container">
            <canvas id="drawingCanvas"></canvas>
            <canvas id="guideCanvas" class="guide-canvas"></canvas>
        </div>

        <div class="controls">
            <button class="btn-prev" onclick="prevChar()">‚óÄ Prev</button>
            <button class="btn-next" onclick="nextChar()">Next ‚ñ∂</button>
        </div>
        <div class="controls controls-three">
            <button class="btn-clear" onclick="clearCanvas()">üóë Clear</button>
            <button class="btn-show-guide" onclick="toggleGuide()">üëÅ Guide</button>
            <button class="btn-check" id="checkBtn" onclick="toggleCheck()">‚úì Done</button>
        </div>

        <div class="stroke-order" id="strokeOrder">Stroke order</div>
    </div>

    <!-- Font Selector Modal -->
    <div class="modal-overlay" id="fontModal">
        <div class="modal-content font-selector-modal">
            <div class="modal-header">
                <h2>üî§ Font</h2>
                <button class="modal-close" onclick="closeFontSelector()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="font-option" data-font="Arial">
                    <div class="font-option-name">Arial (Default)</div>
                    <div class="font-option-preview" style="font-family: Arial;">Í∞ÄÎÇòÎã§Îùº</div>
                </div>
                <div class="font-option" data-font="Malgun Gothic">
                    <div class="font-option-name">ÎßëÏùÄ Í≥†Îîï</div>
                    <div class="font-option-preview" style="font-family: 'Malgun Gothic';">Í∞ÄÎÇòÎã§Îùº</div>
                </div>
                <div class="font-option" data-font="Hi Melody">
                    <div class="font-option-name">ÌïòÏù¥Î©úÎ°úÎîî ‚ú®</div>
                    <div class="font-option-preview" style="font-family: 'Hi Melody';">Í∞ÄÎÇòÎã§Îùº</div>
                </div>
                <div class="font-option" data-font="Gamja Flower">
                    <div class="font-option-name">Í∞êÏûêÍΩÉ üå∏</div>
                    <div class="font-option-preview" style="font-family: 'Gamja Flower';">Í∞ÄÎÇòÎã§Îùº</div>
                </div>
                <div class="font-option" data-font="Gaegu">
                    <div class="font-option-name">Í∞úÍµ¨ üñäÔ∏è</div>
                    <div class="font-option-preview" style="font-family: 'Gaegu';">Í∞ÄÎÇòÎã§Îùº</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal-overlay" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Hangul Chart</h2>
                <button class="modal-close" onclick="closeChart()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="section-title">ÏûêÏùå (Consonants)</div>
                <table class="hangul-table">
                    <thead><tr><th>Char</th><th>Sound</th><th>Description</th></tr></thead>
                    <tbody id="consonantTableBody"></tbody>
                </table>
                <div class="section-title" style="margin-top: 20px;">Î™®Ïùå (Vowels)</div>
                <table class="hangul-table">
                    <thead><tr><th>Char</th><th>Sound</th><th>Description</th></tr></thead>
                    <tbody id="vowelTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal-content quiz-modal-content">
            <div class="modal-header">
                <h2>üéØ Quiz</h2>
                <button class="modal-close" onclick="closeQuiz()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="quiz-container">
                    <div class="quiz-stats">
                        <div class="quiz-stat"><div class="quiz-stat-label">Correct</div><div class="quiz-stat-value correct" id="quizCorrect">0</div></div>
                        <div class="quiz-stat"><div class="quiz-stat-label">Wrong</div><div class="quiz-stat-value wrong" id="quizWrong">0</div></div>
                    </div>
                    <div class="quiz-question" id="quizQuestion">g/k</div>
                    <div class="quiz-answer-area">
                        <div class="quiz-answer" id="quizAnswer" style="visibility: hidden;">„Ñ±</div>
                    </div>
                    <div class="quiz-canvas-container">
                        <canvas id="quizDrawingCanvas" class="quiz-canvas"></canvas>
                        <canvas id="quizGuideCanvas" class="quiz-canvas quiz-guide-canvas"></canvas>
                    </div>
                    <div class="quiz-buttons">
                        <button class="quiz-btn quiz-btn-show" id="showAnswerBtn" onclick="showAnswer()">Show</button>
                        <button class="quiz-btn" onclick="markQuizCorrect()">‚úì O</button>
                        <button class="quiz-btn" onclick="markQuizWrong()">‚úó X</button>
                        <button class="quiz-btn" onclick="nextQuiz()">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Ìè∞Ìä∏ Í¥ÄÎ¶¨ - ÎØ∏Î¶¨ Î°úÎìú
        // ========================================
        const FontManager = {
            currentFont: 'Arial',
            async preloadFonts() {
                try {
                    await Promise.all(['Hi Melody', 'Gamja Flower', 'Gaegu'].map(f => document.fonts.load(`bold 80px "${f}"`)));
                } catch (e) {}
            },
            applyFont(fontName) {
                this.currentFont = fontName;
                document.documentElement.style.setProperty('--korean-font', `'${fontName}'`);
                drawGuideCharacter();
                if (quizGuideCanvas && parseFloat(quizGuideCanvas.style.opacity) > 0) drawQuizGuide();
                try { localStorage.setItem('hangulFont', fontName); } catch (e) {}
            },
            loadSavedFont() {
                try { const s = localStorage.getItem('hangulFont'); if (s) { this.applyFont(s); return s; } } catch (e) {}
                return 'Arial';
            },
            getCanvasFont(size) {
                const f = this.currentFont.includes(' ') ? `'${this.currentFont}'` : this.currentFont;
                return `bold ${size}px ${f}, Arial`;
            }
        };

        // ========================================
        // ÏûêÏùå Îç∞Ïù¥ÌÑ∞ (Í∏∞Î≥∏ 14Í∞ú + ÏåçÏûêÏùå)
        // ========================================
        const consonantData = {
            '„Ñ±': { romaji: 'g/k', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Vertical line (top to bottom)', sound: 'like "g" in "go"', sub: ['„Ñ≤'] },
            '„Ñ≤': { romaji: 'kk', strokes: '‚ë† First „Ñ±\n‚ë° Second „Ñ±', sound: 'tense "k"' },
            '„Ñ¥': { romaji: 'n', strokes: '‚ë† Vertical line (top to bottom)\n‚ë° Horizontal line (left to right)', sound: 'like "n" in "no"' },
            '„Ñ∑': { romaji: 'd/t', strokes: '‚ë† Horizontal line (top, left to right)\n‚ë° Vertical line (right side, top to bottom)\n‚ë¢ Horizontal line (bottom, left to right)', sound: 'like "d" in "do"', sub: ['„Ñ∏'] },
            '„Ñ∏': { romaji: 'tt', strokes: '‚ë† First „Ñ∑\n‚ë° Second „Ñ∑', sound: 'tense "t"' },
            '„Ñπ': { romaji: 'r/l', strokes: '‚ë† Horizontal line (top, left to right)\n‚ë° Vertical line (right, top to bottom)\n‚ë¢ Horizontal line (middle, left to right)\n‚ë£ Vertical line (left, top to bottom)\n‚ë§ Horizontal line (bottom, left to right)', sound: 'like "r" or "l"' },
            '„ÖÅ': { romaji: 'm', strokes: '‚ë† Vertical line (left, top to bottom)\n‚ë° Horizontal line (top, left to right)\n‚ë¢ Vertical line (right, top to bottom)\n‚ë£ Horizontal line (bottom, left to right)', sound: 'like "m" in "mom"' },
            '„ÖÇ': { romaji: 'b/p', strokes: '‚ë† Vertical line (left, top to bottom)\n‚ë° Horizontal line (top, left to right)\n‚ë¢ Vertical line (right, top to bottom)\n‚ë£ Horizontal line (bottom, left to right)', sound: 'like "b" in "book"', sub: ['„ÖÉ'] },
            '„ÖÉ': { romaji: 'pp', strokes: '‚ë† First „ÖÇ\n‚ë° Second „ÖÇ', sound: 'tense "p"' },
            '„ÖÖ': { romaji: 's', strokes: '‚ë† Diagonal line (left, top to bottom)\n‚ë° Diagonal line (right, top to bottom)', sound: 'like "s" in "see"', sub: ['„ÖÜ'] },
            '„ÖÜ': { romaji: 'ss', strokes: '‚ë† First „ÖÖ\n‚ë° Second „ÖÖ', sound: 'tense "s"' },
            '„Öá': { romaji: 'ng/silent', strokes: '‚ë† Circle (start from top, clockwise)', sound: 'silent or "ng"' },
            '„Öà': { romaji: 'j', strokes: '‚ë† Horizontal line (top, left to right)\n‚ë° Diagonal line (left, right to left downward)\n‚ë¢ Diagonal line (right, left to right downward)', sound: 'like "j" in "jump"', sub: ['„Öâ'] },
            '„Öâ': { romaji: 'jj', strokes: '‚ë† First „Öà\n‚ë° Second „Öà', sound: 'tense "j"' },
            '„Öä': { romaji: 'ch', strokes: '‚ë† Vertical line (top, top to bottom)\n‚ë° Horizontal line (middle, left to right)\n‚ë¢ Diagonal line (left, right to left downward)\n‚ë£ Diagonal line (right, left to right downward)', sound: 'like "ch" in "church"' },
            '„Öã': { romaji: 'k', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Vertical line (top to bottom)\n‚ë¢ Horizontal line (right extension, left to right)', sound: 'like "k" in "kite"' },
            '„Öå': { romaji: 't', strokes: '‚ë† Horizontal line (very top, left to right)\n‚ë° Horizontal line (top, left to right)\n‚ë¢ Vertical line (right, top to bottom)\n‚ë£ Horizontal line (bottom, left to right)', sound: 'like "t" in "top"' },
            '„Öç': { romaji: 'p', strokes: '‚ë† Horizontal line (very top, left to right)\n‚ë° Vertical line (left, top to bottom)\n‚ë¢ Vertical line (right, top to bottom)\n‚ë£ Horizontal line (bottom, left to right)', sound: 'like "p" in "pop"' },
            '„Öé': { romaji: 'h', strokes: '‚ë† Vertical line (left, top to bottom)\n‚ë° Horizontal line (top, left to right)\n‚ë¢ Circle (start from top, clockwise)', sound: 'like "h" in "house"' }
        };
        const mainConsonants = ['„Ñ±','„Ñ¥','„Ñ∑','„Ñπ','„ÖÅ','„ÖÇ','„ÖÖ','„Öá','„Öà','„Öä','„Öã','„Öå','„Öç','„Öé'];

        // ========================================
        // Î™®Ïùå Îç∞Ïù¥ÌÑ∞ (Í∏∞Î≥∏ 10Í∞ú + Ïù¥Ï§ëÎ™®Ïùå)
        // ========================================
        const vowelData = {
            '„Öè': { romaji: 'a', strokes: '‚ë† Vertical line (top to bottom)\n‚ë° Short horizontal line (right side, center)', sound: 'like "a" in "father"', sub: ['„Öê'] },
            '„Öê': { romaji: 'ae', strokes: '‚ë† Vertical line\n‚ë° Short horizontal\n‚ë¢ Vertical line', sound: 'like "e" in "bed"' },
            '„Öë': { romaji: 'ya', strokes: '‚ë† Vertical line (top to bottom)\n‚ë° Short horizontal line (top right)\n‚ë¢ Short horizontal line (bottom right)', sound: 'like "ya" in "yard"', sub: ['„Öí'] },
            '„Öí': { romaji: 'yae', strokes: '‚ë† Vertical line\n‚ë° Two short horizontals\n‚ë¢ Vertical line', sound: 'like "ye" in "yes"' },
            '„Öì': { romaji: 'eo', strokes: '‚ë† Vertical line (top to bottom)\n‚ë° Short horizontal line (left side, center)', sound: 'like "uh"', sub: ['„Öî'] },
            '„Öî': { romaji: 'e', strokes: '‚ë† Vertical line\n‚ë° Short horizontal\n‚ë¢ Vertical line', sound: 'like "e" in "bed"' },
            '„Öï': { romaji: 'yeo', strokes: '‚ë† Vertical line (top to bottom)\n‚ë° Short horizontal line (top left)\n‚ë¢ Short horizontal line (bottom left)', sound: 'like "yuh"', sub: ['„Öñ'] },
            '„Öñ': { romaji: 'ye', strokes: '‚ë† Vertical line\n‚ë° Two short horizontals\n‚ë¢ Vertical line', sound: 'like "ye"' },
            '„Öó': { romaji: 'o', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Short vertical line (below, center)', sound: 'like "o" in "go"', sub: ['„Öò','„Öô','„Öö'] },
            '„Öò': { romaji: 'wa', strokes: '‚ë† „Öó shape\n‚ë° „Öè shape', sound: 'like "wa"' },
            '„Öô': { romaji: 'wae', strokes: '‚ë† „Öó shape\n‚ë° „Öê shape', sound: 'like "we"' },
            '„Öö': { romaji: 'oe', strokes: '‚ë† Horizontal\n‚ë° Vertical below\n‚ë¢ Vertical line', sound: 'like "we"' },
            '„Öõ': { romaji: 'yo', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Short vertical line (left below)\n‚ë¢ Short vertical line (right below)', sound: 'like "yo" in "yo-yo"' },
            '„Öú': { romaji: 'u', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Short vertical line (above, center)', sound: 'like "oo" in "food"', sub: ['„Öù','„Öû','„Öü'] },
            '„Öù': { romaji: 'wo', strokes: '‚ë† „Öú shape\n‚ë° „Öì shape', sound: 'like "wo"' },
            '„Öû': { romaji: 'we', strokes: '‚ë† „Öú shape\n‚ë° „Öî shape', sound: 'like "we"' },
            '„Öü': { romaji: 'wi', strokes: '‚ë† „Öú shape\n‚ë° „Ö£ shape', sound: 'like "wee"' },
            '„Ö†': { romaji: 'yu', strokes: '‚ë† Horizontal line (left to right)\n‚ë° Short vertical line (left above)\n‚ë¢ Short vertical line (right above)', sound: 'like "you"' },
            '„Ö°': { romaji: 'eu', strokes: '‚ë† Horizontal line (left to right)', sound: 'like "oo" in "book"', sub: ['„Ö¢'] },
            '„Ö¢': { romaji: 'ui', strokes: '‚ë† Horizontal line\n‚ë° Vertical line', sound: 'like "oo-ee"' },
            '„Ö£': { romaji: 'i', strokes: '‚ë† Vertical line (top to bottom)', sound: 'like "ee" in "see"' }
        };
        const mainVowels = ['„Öè','„Öë','„Öì','„Öï','„Öó','„Öõ','„Öú','„Ö†','„Ö°','„Ö£'];

        // State
        let currentTab = 'consonants';
        let currentMainChar = '„Ñ±';
        let currentSubChar = null; // nullÏù¥Î©¥ Î©îÏù∏ Í∏ÄÏûê, Í∞íÏù¥ ÏûàÏúºÎ©¥ ÏÑúÎ∏å Í∏ÄÏûê
        let isDrawing = false, showGuide = true, checkedChars = {};
        let quizCorrect = 0, quizWrong = 0, currentQuizChar = null;
        let quizCanvas, quizCtx, quizGuideCanvas, quizGuideCtx, isQuizDrawing = false;

        const canvas = document.getElementById('drawingCanvas');
        const guideCanvas = document.getElementById('guideCanvas');
        const ctx = canvas.getContext('2d');
        const guideCtx = guideCanvas.getContext('2d');

        try { const s = localStorage.getItem('hangulChecked'); if (s) checkedChars = JSON.parse(s); } catch (e) {}

        function getData() { return currentTab === 'consonants' ? consonantData : vowelData; }
        function getMainChars() { return currentTab === 'consonants' ? mainConsonants : mainVowels; }
        function getCurrentChar() { return currentSubChar || currentMainChar; }
        function getCharKey(char) { return `${currentTab}-${char}`; }

        function getAllChars() {
            const all = [];
            Object.entries(consonantData).forEach(([c, d]) => all.push({ char: c, ...d }));
            Object.entries(vowelData).forEach(([c, d]) => all.push({ char: c, ...d }));
            return all;
        }

        function initCanvas() {
            const container = document.querySelector('.canvas-container');
            const size = container.offsetWidth;
            canvas.width = size; canvas.height = size;
            guideCanvas.width = size; guideCanvas.height = size;
            ctx.lineWidth = 8; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#f5576c';
            drawGuideCharacter();
        }

        function drawGuideCharacter() {
            if (!guideCanvas.width) return;
            guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
            const char = getCurrentChar();
            const fontSize = guideCanvas.width * 0.65;
            guideCtx.font = FontManager.getCanvasFont(fontSize);
            guideCtx.fillStyle = '#f5576c';
            guideCtx.textAlign = 'center';
            guideCtx.textBaseline = 'middle';
            guideCtx.fillText(char, guideCanvas.width / 2, guideCanvas.height / 2);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return { x: (touch.clientX - rect.left) * (canvas.width / rect.width), y: (touch.clientY - rect.top) * (canvas.height / rect.height) };
        }
        function startDrawing(e) { e.preventDefault(); isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function toggleGuide() { showGuide = !showGuide; guideCanvas.style.opacity = showGuide ? '0.3' : '0'; }

        function toggleCheck() {
            const key = getCharKey(getCurrentChar());
            if (checkedChars[key]) delete checkedChars[key]; else checkedChars[key] = true;
            localStorage.setItem('hangulChecked', JSON.stringify(checkedChars));
            updateDisplay();
        }

        function selectMainChar(char) {
            currentMainChar = char;
            currentSubChar = null;
            updateDisplay();
            clearCanvas();
            drawGuideCharacter();
        }

        function selectSubChar(char) {
            currentSubChar = char;
            updateDisplay();
            clearCanvas();
            drawGuideCharacter();
        }

        function nextChar() {
            const mains = getMainChars();
            const data = getData();
            const mainData = data[currentMainChar];
            
            if (currentSubChar && mainData.sub) {
                const subIdx = mainData.sub.indexOf(currentSubChar);
                if (subIdx < mainData.sub.length - 1) {
                    currentSubChar = mainData.sub[subIdx + 1];
                } else {
                    const mainIdx = mains.indexOf(currentMainChar);
                    currentMainChar = mains[(mainIdx + 1) % mains.length];
                    currentSubChar = null;
                }
            } else if (mainData.sub && mainData.sub.length > 0) {
                currentSubChar = mainData.sub[0];
            } else {
                const mainIdx = mains.indexOf(currentMainChar);
                currentMainChar = mains[(mainIdx + 1) % mains.length];
                currentSubChar = null;
            }
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function prevChar() {
            const mains = getMainChars();
            const data = getData();
            
            if (currentSubChar) {
                const mainData = data[currentMainChar];
                const subIdx = mainData.sub.indexOf(currentSubChar);
                if (subIdx > 0) {
                    currentSubChar = mainData.sub[subIdx - 1];
                } else {
                    currentSubChar = null;
                }
            } else {
                const mainIdx = mains.indexOf(currentMainChar);
                const prevMain = mains[(mainIdx - 1 + mains.length) % mains.length];
                currentMainChar = prevMain;
                const prevData = data[prevMain];
                if (prevData.sub && prevData.sub.length > 0) {
                    currentSubChar = prevData.sub[prevData.sub.length - 1];
                } else {
                    currentSubChar = null;
                }
            }
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function selectTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentMainChar = getMainChars()[0];
            currentSubChar = null;
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function updateMainButtons() {
            const selector = document.getElementById('characterSelector');
            const mains = getMainChars();
            const data = getData();
            selector.innerHTML = '';
            
            mains.forEach(char => {
                const btn = document.createElement('button');
                const charData = data[char];
                const hasCheck = !!checkedChars[getCharKey(char)] || 
                    (charData.sub && charData.sub.some(s => checkedChars[getCharKey(s)]));
                btn.className = 'char-btn' + (char === currentMainChar ? ' active' : '') + (hasCheck ? ' has-check' : '');
                btn.textContent = char;
                btn.onclick = () => selectMainChar(char);
                selector.appendChild(btn);
            });
        }

        function updateSubButtons() {
            const subSelector = document.getElementById('subSelector');
            const data = getData();
            const mainData = data[currentMainChar];
            subSelector.innerHTML = '';

            // Î©îÏù∏ Í∏ÄÏûê Î≤ÑÌäº
            const mainBtn = document.createElement('button');
            mainBtn.className = 'sub-btn' + (!currentSubChar ? ' active' : '') + (checkedChars[getCharKey(currentMainChar)] ? ' checked' : '');
            mainBtn.textContent = currentMainChar;
            mainBtn.onclick = () => selectSubChar(null);
            subSelector.appendChild(mainBtn);

            // ÏÑúÎ∏å Í∏ÄÏûê Î≤ÑÌäºÎì§
            if (mainData.sub) {
                mainData.sub.forEach(subChar => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-btn' + (currentSubChar === subChar ? ' active' : '') + (checkedChars[getCharKey(subChar)] ? ' checked' : '');
                    btn.textContent = subChar;
                    btn.onclick = () => selectSubChar(subChar);
                    subSelector.appendChild(btn);
                });
            }
        }

        function updateDisplay() {
            const char = getCurrentChar();
            const data = getData();
            const charData = data[char];
            
            document.getElementById('currentCharacter').innerHTML = `${char}<span class="check-mark" id="checkMark">‚úì</span>`;
            document.getElementById('characterInfo').textContent = charData.romaji;
            document.getElementById('strokeOrder').textContent = charData.strokes;
            
            const isChecked = !!checkedChars[getCharKey(char)];
            document.getElementById('checkMark').classList.toggle('show', isChecked);
            document.getElementById('checkBtn').classList.toggle('checked', isChecked);
            
            updateMainButtons();
            updateSubButtons();
        }

        // Font
        function openFontSelector() { document.getElementById('fontModal').classList.add('show'); document.body.style.overflow = 'hidden'; updateFontSelection(); }
        function closeFontSelector() { document.getElementById('fontModal').classList.remove('show'); document.body.style.overflow = ''; }
        function updateFontSelection() {
            document.querySelectorAll('.font-option').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-font') === FontManager.currentFont);
            });
        }
        function setupFontOptions() {
            document.querySelectorAll('.font-option').forEach(opt => {
                opt.addEventListener('click', function() { FontManager.applyFont(this.getAttribute('data-font')); updateFontSelection(); });
            });
        }

        // Chart
        function openChart() { document.getElementById('chartModal').classList.add('show'); document.body.style.overflow = 'hidden'; populateChart(); }
        function closeChart() { document.getElementById('chartModal').classList.remove('show'); document.body.style.overflow = ''; }
        function populateChart() {
            const cBody = document.getElementById('consonantTableBody');
            const vBody = document.getElementById('vowelTableBody');
            cBody.innerHTML = ''; vBody.innerHTML = '';
            Object.entries(consonantData).forEach(([c, d]) => {
                cBody.insertRow().innerHTML = `<td><span class="char-main">${c}</span></td><td>${d.romaji}</td><td>${d.sound}</td>`;
            });
            Object.entries(vowelData).forEach(([c, d]) => {
                vBody.insertRow().innerHTML = `<td><span class="char-main">${c}</span></td><td>${d.romaji}</td><td>${d.sound}</td>`;
            });
        }

        // Quiz
        function openQuiz() {
            document.getElementById('quizModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(() => { initQuizCanvas(); nextQuiz(); });
        }
        function closeQuiz() {
            document.getElementById('quizModal').classList.remove('show');
            document.body.style.overflow = '';
            quizCorrect = 0; quizWrong = 0;
            document.getElementById('quizCorrect').textContent = '0';
            document.getElementById('quizWrong').textContent = '0';
        }
        function initQuizCanvas() {
            quizCanvas = document.getElementById('quizDrawingCanvas');
            quizCtx = quizCanvas.getContext('2d');
            quizGuideCanvas = document.getElementById('quizGuideCanvas');
            quizGuideCtx = quizGuideCanvas.getContext('2d');
            const size = document.querySelector('.quiz-canvas-container').offsetWidth;
            quizCanvas.width = size; quizCanvas.height = size;
            quizGuideCanvas.width = size; quizGuideCanvas.height = size;
            quizCtx.lineWidth = 8; quizCtx.lineCap = 'round'; quizCtx.lineJoin = 'round'; quizCtx.strokeStyle = '#20c997';
            quizCanvas.onmousedown = startQuizDraw; quizCanvas.onmousemove = quizDraw;
            quizCanvas.onmouseup = stopQuizDraw; quizCanvas.onmouseout = stopQuizDraw;
            quizCanvas.ontouchstart = startQuizDraw; quizCanvas.ontouchmove = quizDraw; quizCanvas.ontouchend = stopQuizDraw;
        }
        function startQuizDraw(e) { e.preventDefault(); isQuizDrawing = true; const p = getQuizPos(e); quizCtx.beginPath(); quizCtx.moveTo(p.x, p.y); }
        function quizDraw(e) { if (!isQuizDrawing) return; e.preventDefault(); const p = getQuizPos(e); quizCtx.lineTo(p.x, p.y); quizCtx.stroke(); }
        function stopQuizDraw() { isQuizDrawing = false; }
        function getQuizPos(e) { const r = quizCanvas.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: (t.clientX - r.left) * (quizCanvas.width / r.width), y: (t.clientY - r.top) * (quizCanvas.height / r.height) }; }

        function nextQuiz() {
            const all = getAllChars();
            currentQuizChar = all[Math.floor(Math.random() * all.length)];
            document.getElementById('quizQuestion').textContent = currentQuizChar.romaji;
            document.getElementById('quizAnswer').textContent = currentQuizChar.char;
            document.getElementById('quizAnswer').style.visibility = 'hidden';
            document.getElementById('showAnswerBtn').style.display = 'inline-block';
            if (quizCtx) quizCtx.clearRect(0, 0, quizCanvas.width, quizCanvas.height);
            if (quizGuideCanvas) quizGuideCanvas.style.opacity = '0';
        }
        function drawQuizGuide() {
            if (!quizGuideCtx || !currentQuizChar) return;
            quizGuideCtx.clearRect(0, 0, quizGuideCanvas.width, quizGuideCanvas.height);
            const size = quizGuideCanvas.width * 0.65;
            quizGuideCtx.font = FontManager.getCanvasFont(size);
            quizGuideCtx.fillStyle = '#20c997';
            quizGuideCtx.textAlign = 'center';
            quizGuideCtx.textBaseline = 'middle';
            quizGuideCtx.fillText(currentQuizChar.char, quizGuideCanvas.width / 2, quizGuideCanvas.height / 2);
        }
        function showAnswer() {
            document.getElementById('quizAnswer').style.visibility = 'visible';
            document.getElementById('showAnswerBtn').style.display = 'none';
            drawQuizGuide(); quizGuideCanvas.style.opacity = '0.3';
        }
        function markQuizCorrect() { quizCorrect++; document.getElementById('quizCorrect').textContent = quizCorrect; nextQuiz(); }
        function markQuizWrong() { quizWrong++; document.getElementById('quizWrong').textContent = quizWrong; nextQuiz(); }

        // Events
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', stopDrawing);
        window.addEventListener('resize', () => { const w = showGuide; initCanvas(); showGuide = w; guideCanvas.style.opacity = showGuide ? '0.3' : '0'; });

        // Init
        async function init() {
            await FontManager.preloadFonts();
            setupFontOptions();
            FontManager.loadSavedFont();
            initCanvas();
            updateDisplay();
        }
        init();
    </script>
</body>
</html>
