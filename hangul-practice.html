<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangul Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hi+Melody&family=Gamja+Flower&family=Gaegu&display=swap" rel="stylesheet">
    <style>
        :root {
            --korean-font: Arial;
            --korean-font-fallback: Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
			overflow-y: scroll; 
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 25px;
            max-width: 500px;
            width: 100%;
        }

        h1 { color: #f5576c; font-size: 22px; flex: 1; }
        .header { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }

        .back-button {
            background: #e9ecef; border: none; border-radius: 8px;
            width: 36px; height: 36px; cursor: pointer; font-size: 16px;
            transition: all 0.3s; flex-shrink: 0; display: flex;
            align-items: center; justify-content: center;
            text-decoration: none; color: #333;
        }
        .back-button:hover { background: #dee2e6; transform: translateX(-3px); }

        .header-buttons { display: flex; gap: 8px; }

        .chart-button, .quiz-button, .font-button {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none; border-radius: 8px; width: 36px; height: 36px;
            cursor: pointer; font-size: 16px; transition: all 0.3s;
            flex-shrink: 0; display: flex; align-items: center;
            justify-content: center; color: white;
        }
        .quiz-button { background: linear-gradient(135deg, #20c997 0%, #12b886 100%); }
        .font-button { background: linear-gradient(135deg, #845ef7 0%, #7950f2 100%); }
        .chart-button:hover, .quiz-button:hover, .font-button:hover { transform: scale(1.1); }

        .level-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .level-btn {
            padding: 10px 8px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; border-radius: 10px;
            font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;
        }
        .level-btn.active { background: #f5576c; color: white; border-color: #f5576c; }
        .level-btn:hover { transform: translateY(-2px); }

        /* ê¸°ë³¸ ê¸€ì ì„ íƒ (2ì¤„) */
        .character-selector { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
            margin-bottom: 10px; 
        }

        .char-btn {
            padding: 8px 4px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; font-size: 20px; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; position: relative; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .char-btn.active { background: #f5576c; color: white; border-color: #f5576c; }
        .char-btn:hover { transform: scale(1.05); }
        .char-btn.has-check::after {
            content: 'âœ“'; position: absolute; top: -4px; right: -4px;
            width: 14px; height: 14px; background: #51cf66; border-radius: 50%;
            font-size: 9px; color: white; display: flex; align-items: center; justify-content: center;
        }

        /* ì„œë¸Œ ê¸€ì (ìŒììŒ/ì´ì¤‘ëª¨ìŒ) */
        .sub-selector {
            display: flex; justify-content: center; gap: 8px; 
            margin-bottom: 12px; min-height: 44px;
            padding: 8px; background: #f8f9fa; border-radius: 10px;
        }
        .sub-selector:empty { display: none; }
        
        .sub-btn {
            padding: 8px 16px; background: #e9ecef; color: #495057;
            border: 2px solid transparent; font-size: 22px; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
            position: relative;
        }
        .sub-btn.active { background: #ff6b9d; color: white; border-color: #ff6b9d; }
        .sub-btn:hover { transform: scale(1.05); }
        .sub-btn.checked::after {
            content: 'âœ“'; position: absolute; top: -4px; right: -4px;
            width: 14px; height: 14px; background: #51cf66; border-radius: 50%;
            font-size: 9px; color: white; display: flex; align-items: center; justify-content: center;
        }

		/* í•œê¸€ ê¸€ì í‘œì‹œë¥¼ ìˆ¨ê¸°ê³  ì •ë³´ë¥¼ ê°•ì¡°í•˜ë„ë¡ ìˆ˜ì • */
		.character-display { 
			text-align: center; 
			margin-bottom: 20px; 
			padding: 10px;
			background: #fff5f6;
			border-radius: 15px;
		}

		/* ê¸°ì¡´ í° ê¸€ì ì œê±° ë˜ëŠ” í¬ê¸° ìµœì†Œí™” */
		.current-character {
			display: none; /* í•œê¸€ ê¸€ìëŠ” ë²„íŠ¼ì— ì´ë¯¸ ìˆìœ¼ë¯€ë¡œ ìˆ¨ê¹€ */
		}
        .check-mark {
            position: absolute; top: -8px; right: -8px; background: #51cf66;
            color: white; width: 26px; height: 26px; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-size: 16px;
        }
        .check-mark.show { display: flex; }
		.character-info { 
				font-size: 24px; /* ë°œìŒ ê¸°í˜¸ í¬ê¸° í™•ëŒ€ */
				font-weight: bold;
				color: #f5576c;
				letter-spacing: 1px;
			}
		.canvas-container {
			position: relative; 
			width: 100%; 
			max-width: 220px;
			margin: 0 auto 12px; 
			aspect-ratio: 1.25 / 1; /* ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ë¹„ìœ¨ì„ ì¤„ì„ (ê¸°ì¡´ 1/1) */
			border-radius: 10px; 
			overflow: hidden;
		}
        canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 3px solid #f5576c; border-radius: 10px; background: white; touch-action: none;
        }
        .guide-canvas { opacity: 0.15; pointer-events: none; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .controls-three { display: grid; grid-template-columns: repeat(3, 1fr); }
        button { padding: 10px 8px; border: none; border-radius: 10px; font-size: 13px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-clear { background: #ff6b9d; color: white; }
        .btn-next { background: #51cf66; color: white; }
        .btn-prev { background: #74c0fc; color: white; }
        .btn-show-guide { background: #ffd43b; color: #333; }
        .btn-check { background: #845ef7; color: white; }
        .btn-check.checked { background: #51cf66; }

		.stroke-order {
			margin-top: 10px; 
			padding: 10px; 
			background: #e7f5ff;
			border-radius: 8px; 
			font-size: 13px; /* ê°€ë…ì„±ì„ ìœ„í•´ í¬ê¸° ì•½ê°„ ì¡°ì • */
			color: #1864ab;
			line-height: 1.5; 
			white-space: pre-line;
			
			/* ë†’ì´ ê³ ì • ì„¤ì • */
			height: 118px;      /* 5ì¤„ ë¶„ëŸ‰ì˜ ë†’ì´ */
			overflow-y: auto;   /* í˜¹ì‹œ 5ì¤„ì´ ë„˜ì–´ê°€ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ìƒì„± */
			display: block;
		}

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 2px solid #f1f3f5;
            position: sticky; top: 0; background: white; z-index: 10; border-radius: 20px 20px 0 0;
        }
        .modal-header h2 { color: #f5576c; font-size: 20px; }
        .modal-close { 
            background: #e9ecef; border: none; border-radius: 50%; 
            width: 32px; height: 32px; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .modal-body { padding: 20px; }

        /* Chart */
        .hangul-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .hangul-table th, .hangul-table td { padding: 10px 6px; text-align: center; border: 1px solid #e9ecef; font-size: 14px; }
        .hangul-table th { background: #f8f9fa; font-weight: bold; color: #495057; }
        .char-main {
            font-size: 22px; font-weight: bold; color: #f5576c;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .section-title { font-size: 16px; font-weight: bold; color: #495057; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #f5576c; }

        /* Font selector */
        .font-selector-modal { max-width: 380px; }
        .font-option {
            padding: 12px; margin: 8px 0; background: #f8f9fa; border: 2px solid transparent;
            border-radius: 10px; cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .font-option:hover { background: #e9ecef; }
        .font-option.active { background: #f5576c; color: white; border-color: #f5576c; }
        .font-option-name { font-weight: bold; margin-bottom: 4px; font-size: 14px; }
        .font-option-preview { font-size: 28px; margin-top: 8px; }

        /* Quiz */
        .quiz-modal-content { width: 420px; max-width: 95vw; }
        .quiz-container { text-align: center; }
        .quiz-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 10px; }
        .quiz-stat { text-align: center; }
        .quiz-stat-label { font-size: 11px; color: #868e96; margin-bottom: 2px; }
        .quiz-stat-value { font-size: 22px; font-weight: bold; }
        .quiz-stat-value.correct { color: #51cf66; }
        .quiz-stat-value.wrong { color: #ff6b9d; }
        .quiz-question { font-size: 42px; color: #495057; margin: 15px 0; font-weight: bold; min-height: 50px; }
        .quiz-answer-area { min-height: 70px; display: flex; align-items: center; justify-content: center; }
        .quiz-answer {
            font-size: 58px; color: #20c997; font-weight: bold;
            font-family: var(--korean-font), var(--korean-font-fallback);
        }
        .quiz-canvas-container {
            position: relative; width: 100%; max-width: 220px;
            margin: 0 auto 15px; aspect-ratio: 1 / 1; border-radius: 10px; overflow: hidden;
        }
        .quiz-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 3px solid #20c997; border-radius: 10px; background: white; touch-action: none;
        }
        .quiz-guide-canvas { opacity: 0; pointer-events: none; }
        .quiz-buttons { display: flex; gap: 6px; }
		.quiz-btn { flex: 1; }
        .quiz-btn { 
            padding: 10px 6px; background: #20c997; color: white; 
            border: none; border-radius: 10px; cursor: pointer; 
            font-size: 13px; font-weight: bold;
        }
        .quiz-btn-show { background: #845ef7; }

        @media (max-width: 480px) {
            .container { padding: 18px 15px; }
            h1 { font-size: 18px; }
            .current-character { font-size: 55px; }
            .char-btn { font-size: 18px; padding: 6px 2px; }
            .sub-btn { font-size: 20px; padding: 6px 12px; }
            .canvas-container { max-width: 200px; }
            .quiz-canvas-container { max-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">â†</a>
            <h1>âœï¸ Hangul Practice</h1>
            <div class="header-buttons">
                <button class="font-button" onclick="openFontSelector()" title="Font">F</button>
                <button class="quiz-button" onclick="openQuiz()" title="Quiz">Q</button>
                <button class="chart-button" onclick="openChart()" title="Chart">í‘œ</button>
            </div>
        </div>

        <div class="level-selector">
            <button class="level-btn active" onclick="selectTab('consonants')">Consonants (ììŒ)</button>
            <button class="level-btn" onclick="selectTab('vowels')">Vowels (ëª¨ìŒ)</button>
        </div>

        <div class="character-selector" id="characterSelector"></div>
        <div class="sub-selector" id="subSelector"></div>

		<div class="character-display">
			<div class="character-info" id="characterInfo">giyeok (g/k)</div>
			<div id="currentCharacter" style="display:none;">ã„±</div> </div>

		<div class="canvas-container">
			<canvas id="drawingCanvas"></canvas>
			<canvas id="guideCanvas" class="guide-canvas"></canvas>
		</div>

        <div class="controls">
            <button class="btn-prev" onclick="prevChar()">â—€ Prev</button>
            <button class="btn-next" onclick="nextChar()">Next â–¶</button>
        </div>
        <div class="controls controls-three">
            <button class="btn-clear" onclick="clearCanvas()">ğŸ—‘ Clear</button>
            <button class="btn-show-guide" onclick="toggleGuide()">ğŸ‘ Guide</button>
            <button class="btn-check" id="checkBtn" onclick="toggleCheck()">âœ“ Done</button>
        </div>

        <div class="stroke-order" id="strokeOrder">Stroke order</div>
    </div>

    <!-- Font Selector Modal -->
    <div class="modal-overlay" id="fontModal">
        <div class="modal-content font-selector-modal">
            <div class="modal-header">
                <h2>ğŸ”¤ Font</h2>
                <button class="modal-close" onclick="closeFontSelector()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="font-option" data-font="Arial">
                    <div class="font-option-name">Arial (Default)</div>
                    <div class="font-option-preview" style="font-family: Arial;">ê°€ë‚˜ë‹¤ë¼</div>
                </div>
                <div class="font-option" data-font="Malgun Gothic">
                    <div class="font-option-name">ë§‘ì€ ê³ ë”•</div>
                    <div class="font-option-preview" style="font-family: 'Malgun Gothic';">ê°€ë‚˜ë‹¤ë¼</div>
                </div>
                <div class="font-option" data-font="Hi Melody">
                    <div class="font-option-name">í•˜ì´ë©œë¡œë”” âœ¨</div>
                    <div class="font-option-preview" style="font-family: 'Hi Melody';">ê°€ë‚˜ë‹¤ë¼</div>
                </div>
                <div class="font-option" data-font="Gamja Flower">
                    <div class="font-option-name">ê°ìê½ƒ ğŸŒ¸</div>
                    <div class="font-option-preview" style="font-family: 'Gamja Flower';">ê°€ë‚˜ë‹¤ë¼</div>
                </div>
                <div class="font-option" data-font="Gaegu">
                    <div class="font-option-name">ê°œêµ¬ ğŸ–Šï¸</div>
                    <div class="font-option-preview" style="font-family: 'Gaegu';">ê°€ë‚˜ë‹¤ë¼</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal-overlay" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ Hangul Chart</h2>
                <button class="modal-close" onclick="closeChart()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="section-title">ììŒ (Consonants)</div>
                <table class="hangul-table">
                    <thead><tr><th>Char</th><th>Sound</th><th>Description</th></tr></thead>
                    <tbody id="consonantTableBody"></tbody>
                </table>
                <div class="section-title" style="margin-top: 20px;">ëª¨ìŒ (Vowels)</div>
                <table class="hangul-table">
                    <thead><tr><th>Char</th><th>Sound</th><th>Description</th></tr></thead>
                    <tbody id="vowelTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal-content quiz-modal-content">
            <div class="modal-header">
                <h2>ğŸ¯ Quiz</h2>
                <button class="modal-close" onclick="closeQuiz()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="quiz-container">
                    <div class="quiz-stats">
                        <div class="quiz-stat"><div class="quiz-stat-label">Correct</div><div class="quiz-stat-value correct" id="quizCorrect">0</div></div>
                        <div class="quiz-stat"><div class="quiz-stat-label">Wrong</div><div class="quiz-stat-value wrong" id="quizWrong">0</div></div>
                    </div>
                    <div class="quiz-question" id="quizQuestion">giyeok (g/k)</div>
                    <div class="quiz-answer-area">
                        <div class="quiz-answer" id="quizAnswer" style="visibility: hidden;">ã„±</div>
                    </div>
                    <div class="quiz-canvas-container">
                        <canvas id="quizDrawingCanvas" class="quiz-canvas"></canvas>
                        <canvas id="quizGuideCanvas" class="quiz-canvas quiz-guide-canvas"></canvas>
                    </div>
                    <div class="quiz-buttons">
                        <button class="quiz-btn quiz-btn-show" id="showAnswerBtn" onclick="showAnswer()">Show</button>
                        <button class="quiz-btn" onclick="markQuizCorrect()">âœ“ O</button>
                        <button class="quiz-btn" onclick="markQuizWrong()">âœ— X</button>
                        <button class="quiz-btn" onclick="nextQuiz()">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // í°íŠ¸ ê´€ë¦¬ - ë¯¸ë¦¬ ë¡œë“œ
        // ========================================
        const FontManager = {
            currentFont: 'Arial',
            async preloadFonts() {
                try {
                    await Promise.all(['Hi Melody', 'Gamja Flower', 'Gaegu'].map(f => document.fonts.load(`bold 80px "${f}"`)));
                } catch (e) {}
            },
            applyFont(fontName) {
                this.currentFont = fontName;
                document.documentElement.style.setProperty('--korean-font', `'${fontName}'`);
                drawGuideCharacter();
                if (quizGuideCanvas && parseFloat(quizGuideCanvas.style.opacity) > 0) drawQuizGuide();
                try { localStorage.setItem('hangulFont', fontName); } catch (e) {}
            },
            loadSavedFont() {
                try { const s = localStorage.getItem('hangulFont'); if (s) { this.applyFont(s); return s; } } catch (e) {}
                return 'Arial';
            },
            getCanvasFont(size) {
                const f = this.currentFont.includes(' ') ? `'${this.currentFont}'` : this.currentFont;
                return `bold ${size}px ${f}, Arial`;
            }
        };

        // ========================================
        // ììŒ ë°ì´í„° (ê¸°ë³¸ 14ê°œ + ìŒììŒ) - ì´ë¯¸ì§€ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •
        // ========================================
        const consonantData = {
            'ã„±': { romaji: 'giyeok (g/k)', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Vertical line (top to bottom)', sound: 'like "g" in "go"', sub: ['ã„²'] },
            'ã„²': { romaji: 'ssang giyeok (kk)', strokes: 'â‘  First ã„±\nâ‘¡ Second ã„±', sound: 'tense "k"' },
            'ã„´': { romaji: 'nieun (n)', strokes: 'â‘  Vertical line (top to bottom)\nâ‘¡ Horizontal line (left to right)', sound: 'like "n" in "no"' },
            'ã„·': { romaji: 'digeut (d/t)', strokes: 'â‘  Horizontal line (top, left to right)\nâ‘¡ Vertical line (right side, top to bottom)\nâ‘¢ Horizontal line (bottom, left to right)', sound: 'like "d" in "do"', sub: ['ã„¸'] },
            'ã„¸': { romaji: 'ssang digeut (tt)', strokes: 'â‘  First ã„·\nâ‘¡ Second ã„·', sound: 'tense "t"' },
            'ã„¹': { romaji: 'rieul (r/l)', strokes: 'â‘  Horizontal line (top, left to right)\nâ‘¡ Vertical line (right, top to bottom)\nâ‘¢ Horizontal line (middle, left to right)\nâ‘£ Vertical line (left, top to bottom)\nâ‘¤ Horizontal line (bottom, left to right)', sound: 'like "r" or "l"' },
            'ã…': { romaji: 'mieum (m)', strokes: 'â‘  Vertical line (left, top to bottom)\nâ‘¡ Horizontal line (top, left to right)\nâ‘¢ Vertical line (right, top to bottom)\nâ‘£ Horizontal line (bottom, left to right)', sound: 'like "m" in "mom"' },
            'ã…‚': { romaji: 'bieup (b/p)', strokes: 'â‘  Vertical line (left, top to bottom)\nâ‘¡ Horizontal line (top, left to right)\nâ‘¢ Vertical line (right, top to bottom)\nâ‘£ Horizontal line (bottom, left to right)', sound: 'like "b" in "book"', sub: ['ã…ƒ'] },
            'ã…ƒ': { romaji: 'ssang bieup (pp)', strokes: 'â‘  First ã…‚\nâ‘¡ Second ã…‚', sound: 'tense "p"' },
            'ã……': { romaji: 'shiot (s)', strokes: 'â‘  Diagonal line (left, right to left downward)\nâ‘¡ Diagonal line (right, left to right downward)', sound: 'like "s" in "see"', sub: ['ã…†'] },
            'ã…†': { romaji: 'ssang shiot (ss)', strokes: 'â‘  First ã……\nâ‘¡ Second ã……', sound: 'tense "s"' },
            'ã…‡': { romaji: 'ieung (ng/silent)', strokes: 'â‘  Circle (start from top, clockwise)', sound: 'silent or "ng"' },
            'ã…ˆ': { romaji: 'jieut (j)', strokes: 'â‘  Horizontal line (top, left to right)\nâ‘¡ Diagonal line (left, right to left downward)\nâ‘¢ Diagonal line (right, left to right downward)', sound: 'like "j" in "jump"', sub: ['ã…‰'] },
            'ã…‰': { romaji: 'ssang jieut (jj)', strokes: 'â‘  First ã…ˆ\nâ‘¡ Second ã…ˆ', sound: 'tense "j"' },
            'ã…Š': { romaji: 'chieut (ch)', strokes: 'â‘  Vertical line (top, top to bottom)\nâ‘¡ Horizontal line (middle, left to right)\nâ‘¢ Diagonal line (left, right to left downward)\nâ‘£ Diagonal line (right, left to right downward)', sound: 'like "ch" in "church"' },
            'ã…‹': { romaji: 'kieuk (k)', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Vertical line (top to bottom)\nâ‘¢ Horizontal line (right extension, left to right)', sound: 'like "k" in "kite"' },
            'ã…Œ': { romaji: 'tieut (t)', strokes: 'â‘  Horizontal line (very top, left to right)\nâ‘¡ Horizontal line (top, left to right)\nâ‘¢ Vertical line (right, top to bottom)\nâ‘£ Horizontal line (bottom, left to right)', sound: 'like "t" in "top"' },
            'ã…': { romaji: 'pieup (p)', strokes: 'â‘  Horizontal line (very top, left to right)\nâ‘¡ Vertical line (left, top to bottom)\nâ‘¢ Vertical line (right, top to bottom)\nâ‘£ Horizontal line (bottom, left to right)', sound: 'like "p" in "pop"' },
            'ã…': { romaji: 'hieut (h)', strokes: 'â‘  Vertical line (very top, top to bottom)\nâ‘¡ Horizontal line (top, left to right)\nâ‘¢ Circle (start from top, clockwise)', sound: 'like "h" in "house"' }
        };
        const mainConsonants = ['ã„±','ã„´','ã„·','ã„¹','ã…','ã…‚','ã……','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];

        // ========================================
        // ëª¨ìŒ ë°ì´í„° (ê¸°ë³¸ 10ê°œ + ì´ì¤‘ëª¨ìŒ)
        // ========================================
        const vowelData = {
            'ã…': { romaji: 'a', strokes: 'â‘  Vertical line (top to bottom)\nâ‘¡ Short horizontal line (right side, center)', sound: 'like "a" in "father"', sub: ['ã…'] },
            'ã…': { romaji: 'ae', strokes: 'â‘  Vertical line\nâ‘¡ Short horizontal\nâ‘¢ Vertical line', sound: 'like "e" in "bed"' },
            'ã…‘': { romaji: 'ya', strokes: 'â‘  Vertical line (top to bottom)\nâ‘¡ Short horizontal line (top right)\nâ‘¢ Short horizontal line (bottom right)', sound: 'like "ya" in "yard"', sub: ['ã…’'] },
            'ã…’': { romaji: 'yae', strokes: 'â‘  Vertical line\nâ‘¡ Two short horizontals\nâ‘¢ Vertical line', sound: 'like "ye" in "yes"' },
            'ã…“': { romaji: 'eo', strokes: 'â‘  Vertical line (top to bottom)\nâ‘¡ Short horizontal line (left side, center)', sound: 'like "uh"', sub: ['ã…”'] },
            'ã…”': { romaji: 'e', strokes: 'â‘  Vertical line\nâ‘¡ Short horizontal\nâ‘¢ Vertical line', sound: 'like "e" in "bed"' },
            'ã…•': { romaji: 'yeo', strokes: 'â‘  Vertical line (top to bottom)\nâ‘¡ Short horizontal line (top left)\nâ‘¢ Short horizontal line (bottom left)', sound: 'like "yuh"', sub: ['ã…–'] },
            'ã…–': { romaji: 'ye', strokes: 'â‘  Vertical line\nâ‘¡ Two short horizontals\nâ‘¢ Vertical line', sound: 'like "ye"' },
            'ã…—': { romaji: 'o', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Short vertical line (below, center)', sound: 'like "o" in "go"', sub: ['ã…˜','ã…™','ã…š'] },
            'ã…˜': { romaji: 'wa', strokes: 'â‘  ã…— shape\nâ‘¡ ã… shape', sound: 'like "wa"' },
            'ã…™': { romaji: 'wae', strokes: 'â‘  ã…— shape\nâ‘¡ ã… shape', sound: 'like "we"' },
            'ã…š': { romaji: 'oe', strokes: 'â‘  Horizontal\nâ‘¡ Vertical below\nâ‘¢ Vertical line', sound: 'like "we"' },
            'ã…›': { romaji: 'yo', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Short vertical line (left below)\nâ‘¢ Short vertical line (right below)', sound: 'like "yo" in "yo-yo"' },
            'ã…œ': { romaji: 'u', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Short vertical line (above, center)', sound: 'like "oo" in "food"', sub: ['ã…','ã…','ã…Ÿ'] },
            'ã…': { romaji: 'wo', strokes: 'â‘  ã…œ shape\nâ‘¡ ã…“ shape', sound: 'like "wo"' },
            'ã…': { romaji: 'we', strokes: 'â‘  ã…œ shape\nâ‘¡ ã…” shape', sound: 'like "we"' },
            'ã…Ÿ': { romaji: 'wi', strokes: 'â‘  ã…œ shape\nâ‘¡ ã…£ shape', sound: 'like "wee"' },
            'ã… ': { romaji: 'yu', strokes: 'â‘  Horizontal line (left to right)\nâ‘¡ Short vertical line (left above)\nâ‘¢ Short vertical line (right above)', sound: 'like "you"' },
            'ã…¡': { romaji: 'eu', strokes: 'â‘  Horizontal line (left to right)', sound: 'like "oo" in "book"', sub: ['ã…¢'] },
            'ã…¢': { romaji: 'ui', strokes: 'â‘  Horizontal line\nâ‘¡ Vertical line', sound: 'like "oo-ee"' },
            'ã…£': { romaji: 'i', strokes: 'â‘  Vertical line (top to bottom)', sound: 'like "ee" in "see"' }
        };
        const mainVowels = ['ã…','ã…‘','ã…“','ã…•','ã…—','ã…›','ã…œ','ã… ','ã…¡','ã…£'];

        // State
        let currentTab = 'consonants';
        let currentMainChar = 'ã„±';
        let currentSubChar = null; // nullì´ë©´ ë©”ì¸ ê¸€ì, ê°’ì´ ìˆìœ¼ë©´ ì„œë¸Œ ê¸€ì
        let isDrawing = false, showGuide = true, checkedChars = {};
        let quizCorrect = 0, quizWrong = 0, currentQuizChar = null;
        let quizCanvas, quizCtx, quizGuideCanvas, quizGuideCtx, isQuizDrawing = false;

        const canvas = document.getElementById('drawingCanvas');
        const guideCanvas = document.getElementById('guideCanvas');
        const ctx = canvas.getContext('2d');
        const guideCtx = guideCanvas.getContext('2d');

        try { const s = localStorage.getItem('hangulChecked'); if (s) checkedChars = JSON.parse(s); } catch (e) {}

        function getData() { return currentTab === 'consonants' ? consonantData : vowelData; }
        function getMainChars() { return currentTab === 'consonants' ? mainConsonants : mainVowels; }
        function getCurrentChar() { return currentSubChar || currentMainChar; }
        function getCharKey(char) { return `${currentTab}-${char}`; }

        function getAllChars() {
            const all = [];
            Object.entries(consonantData).forEach(([c, d]) => all.push({ char: c, ...d }));
            Object.entries(vowelData).forEach(([c, d]) => all.push({ char: c, ...d }));
            return all;
        }

		function initCanvas() {
			const container = document.querySelector('.canvas-container');
			let width = container.offsetWidth;
			if (width === 0) width = 220; // fallback í¬ê¸°
			const height = width * 0.8; // ì„¸ë¡œë¥¼ ê°€ë¡œì˜ 80%ë¡œ ì„¤ì • (20% ê°ì†Œ)
			canvas.width = width; 
			canvas.height = height;
			guideCanvas.width = width; 
			guideCanvas.height = height;
			// ìº”ë²„ìŠ¤ í¬ê¸° ë³€ê²½ í›„ ì»¨í…ìŠ¤íŠ¸ ì†ì„± ì¬ì„¤ì • (í¬ê¸° ë³€ê²½ì‹œ ë¦¬ì…‹ë¨)
			ctx.lineWidth = 8; 
			ctx.lineCap = 'round'; 
			ctx.lineJoin = 'round'; 
			ctx.strokeStyle = '#f5576c';
            drawGuideCharacter();
        }

		function drawGuideCharacter() {
			if (!guideCanvas.width) return;
			guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
			const char = getCurrentChar();
			
			// 1. í°íŠ¸ í¬ê¸°ë¥¼ ìº”ë²„ìŠ¤ ë†’ì´ì˜ 80% -> 70%ë¡œ ì¡°ì • (ì¹˜ìš°ì¹¨ ë°©ì§€)
			const fontSize = guideCanvas.height * 0.9; 
			guideCtx.font = FontManager.getCanvasFont(fontSize);
			guideCtx.fillStyle = '#f5576c';
			guideCtx.textAlign = 'center';
			guideCtx.textBaseline = 'middle'; 

			// 2. ì„¸ë¡œ ìœ„ì¹˜ ë³´ì • (centerY)
			// ê¸°ë³¸ì€ height / 2 ì´ì§€ë§Œ, ì—¬ì „íˆ ìœ„ë¡œ ì¹˜ìš°ì³ ë³´ì¸ë‹¤ë©´ +5 ~ +10 ì •ë„ë¥¼ ë”í•´ì¤ë‹ˆë‹¤.
			const centerX = guideCanvas.width / 2;
			const centerY = (guideCanvas.height / 2) + (fontSize * 0.05); // í°íŠ¸ í¬ê¸°ì˜ 5%ë§Œí¼ ì•„ë˜ë¡œ ë³´ì •

			guideCtx.fillText(char, centerX, centerY);
		}

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return { x: (touch.clientX - rect.left) * (canvas.width / rect.width), y: (touch.clientY - rect.top) * (canvas.height / rect.height) };
        }
        function startDrawing(e) { e.preventDefault(); isDrawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function toggleGuide() { showGuide = !showGuide; guideCanvas.style.opacity = showGuide ? '0.3' : '0'; }

        function toggleCheck() {
            const key = getCharKey(getCurrentChar());
            if (checkedChars[key]) delete checkedChars[key]; else checkedChars[key] = true;
            localStorage.setItem('hangulChecked', JSON.stringify(checkedChars));
            updateDisplay();
        }

        function selectMainChar(char) {
            currentMainChar = char;
            currentSubChar = null;
            updateDisplay();
            clearCanvas();
            drawGuideCharacter();
        }

        function selectSubChar(char) {
            currentSubChar = char;
            updateDisplay();
            clearCanvas();
            drawGuideCharacter();
        }

        function nextChar() {
            const mains = getMainChars();
            const data = getData();
            const mainData = data[currentMainChar];
            
            if (currentSubChar && mainData.sub) {
                const subIdx = mainData.sub.indexOf(currentSubChar);
                if (subIdx < mainData.sub.length - 1) {
                    currentSubChar = mainData.sub[subIdx + 1];
                } else {
                    const mainIdx = mains.indexOf(currentMainChar);
                    currentMainChar = mains[(mainIdx + 1) % mains.length];
                    currentSubChar = null;
                }
            } else if (mainData.sub && mainData.sub.length > 0) {
                currentSubChar = mainData.sub[0];
            } else {
                const mainIdx = mains.indexOf(currentMainChar);
                currentMainChar = mains[(mainIdx + 1) % mains.length];
                currentSubChar = null;
            }
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function prevChar() {
            const mains = getMainChars();
            const data = getData();
            
            if (currentSubChar) {
                const mainData = data[currentMainChar];
                const subIdx = mainData.sub.indexOf(currentSubChar);
                if (subIdx > 0) {
                    currentSubChar = mainData.sub[subIdx - 1];
                } else {
                    currentSubChar = null;
                }
            } else {
                const mainIdx = mains.indexOf(currentMainChar);
                const prevMain = mains[(mainIdx - 1 + mains.length) % mains.length];
                currentMainChar = prevMain;
                const prevData = data[prevMain];
                if (prevData.sub && prevData.sub.length > 0) {
                    currentSubChar = prevData.sub[prevData.sub.length - 1];
                } else {
                    currentSubChar = null;
                }
            }
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function selectTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            currentMainChar = getMainChars()[0];
            currentSubChar = null;
            updateDisplay(); clearCanvas(); drawGuideCharacter();
        }

        function updateMainButtons() {
            const selector = document.getElementById('characterSelector');
            const mains = getMainChars();
            const data = getData();
            selector.innerHTML = '';
            
            mains.forEach(char => {
                const btn = document.createElement('button');
                const charData = data[char];
                const hasCheck = !!checkedChars[getCharKey(char)] || 
                    (charData.sub && charData.sub.some(s => checkedChars[getCharKey(s)]));
                btn.className = 'char-btn' + (char === currentMainChar ? ' active' : '') + (hasCheck ? ' has-check' : '');
                btn.textContent = char;
                btn.onclick = () => selectMainChar(char);
                selector.appendChild(btn);
            });
        }

        function updateSubButtons() {
            const subSelector = document.getElementById('subSelector');
            const data = getData();
            const mainData = data[currentMainChar];
            subSelector.innerHTML = '';

            // ë©”ì¸ ê¸€ì ë²„íŠ¼
            const mainBtn = document.createElement('button');
            mainBtn.className = 'sub-btn' + (!currentSubChar ? ' active' : '') + (checkedChars[getCharKey(currentMainChar)] ? ' checked' : '');
            mainBtn.textContent = currentMainChar;
            mainBtn.onclick = () => selectSubChar(null);
            subSelector.appendChild(mainBtn);

            // ì„œë¸Œ ê¸€ì ë²„íŠ¼ë“¤
            if (mainData.sub) {
                mainData.sub.forEach(subChar => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-btn' + (currentSubChar === subChar ? ' active' : '') + (checkedChars[getCharKey(subChar)] ? ' checked' : '');
                    btn.textContent = subChar;
                    btn.onclick = () => selectSubChar(subChar);
                    subSelector.appendChild(btn);
                });
            }
        }

        function updateDisplay() {
            const char = getCurrentChar();
            const data = getData();
            const charData = data[char];
            
            document.getElementById('currentCharacter').innerHTML = `${char}<span class="check-mark" id="checkMark">âœ“</span>`;
            document.getElementById('characterInfo').textContent = charData.romaji;
			
			// íšìˆœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
			const strokeOrderElement = document.getElementById('strokeOrder');
			strokeOrderElement.textContent = charData.strokes;
            document.getElementById('strokeOrder').textContent = charData.strokes;
            
            const isChecked = !!checkedChars[getCharKey(char)];
            document.getElementById('checkMark').classList.toggle('show', isChecked);
            document.getElementById('checkBtn').classList.toggle('checked', isChecked);
            
            updateMainButtons();
            updateSubButtons();
        }

        // Font
        function openFontSelector() { document.getElementById('fontModal').classList.add('show'); document.body.style.overflow = 'hidden'; updateFontSelection(); }
        function closeFontSelector() { document.getElementById('fontModal').classList.remove('show'); document.body.style.overflow = ''; }
        function updateFontSelection() {
            document.querySelectorAll('.font-option').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-font') === FontManager.currentFont);
            });
        }
        function setupFontOptions() {
            document.querySelectorAll('.font-option').forEach(opt => {
                opt.addEventListener('click', function() { FontManager.applyFont(this.getAttribute('data-font')); updateFontSelection(); });
            });
        }

        // Chart
        function openChart() { document.getElementById('chartModal').classList.add('show'); document.body.style.overflow = 'hidden'; populateChart(); }
        function closeChart() { document.getElementById('chartModal').classList.remove('show'); document.body.style.overflow = ''; }
        function populateChart() {
            const cBody = document.getElementById('consonantTableBody');
            const vBody = document.getElementById('vowelTableBody');
            cBody.innerHTML = ''; vBody.innerHTML = '';
            Object.entries(consonantData).forEach(([c, d]) => {
                cBody.insertRow().innerHTML = `<td><span class="char-main">${c}</span></td><td>${d.romaji}</td><td>${d.sound}</td>`;
            });
            Object.entries(vowelData).forEach(([c, d]) => {
                vBody.insertRow().innerHTML = `<td><span class="char-main">${c}</span></td><td>${d.romaji}</td><td>${d.sound}</td>`;
            });
        }

        // Quiz
        function openQuiz() {
            document.getElementById('quizModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(() => { initQuizCanvas(); nextQuiz(); });
        }
        function closeQuiz() {
            document.getElementById('quizModal').classList.remove('show');
            document.body.style.overflow = '';
            quizCorrect = 0; quizWrong = 0;
            document.getElementById('quizCorrect').textContent = '0';
            document.getElementById('quizWrong').textContent = '0';
        }
        function initQuizCanvas() {
            quizCanvas = document.getElementById('quizDrawingCanvas');
            quizCtx = quizCanvas.getContext('2d');
            quizGuideCanvas = document.getElementById('quizGuideCanvas');
            quizGuideCtx = quizGuideCanvas.getContext('2d');
            const size = document.querySelector('.quiz-canvas-container').offsetWidth;
            quizCanvas.width = size; quizCanvas.height = size;
            quizGuideCanvas.width = size; quizGuideCanvas.height = size;
            quizCtx.lineWidth = 8; quizCtx.lineCap = 'round'; quizCtx.lineJoin = 'round'; quizCtx.strokeStyle = '#20c997';
            quizCanvas.onmousedown = startQuizDraw; quizCanvas.onmousemove = quizDraw;
            quizCanvas.onmouseup = stopQuizDraw; quizCanvas.onmouseout = stopQuizDraw;
            quizCanvas.ontouchstart = startQuizDraw; quizCanvas.ontouchmove = quizDraw; quizCanvas.ontouchend = stopQuizDraw;
        }
        function startQuizDraw(e) { e.preventDefault(); isQuizDrawing = true; const p = getQuizPos(e); quizCtx.beginPath(); quizCtx.moveTo(p.x, p.y); }
        function quizDraw(e) { if (!isQuizDrawing) return; e.preventDefault(); const p = getQuizPos(e); quizCtx.lineTo(p.x, p.y); quizCtx.stroke(); }
        function stopQuizDraw() { isQuizDrawing = false; }
        function getQuizPos(e) { const r = quizCanvas.getBoundingClientRect(); const t = e.touches ? e.touches[0] : e; return { x: (t.clientX - r.left) * (quizCanvas.width / r.width), y: (t.clientY - r.top) * (quizCanvas.height / r.height) }; }

        function nextQuiz() {
            const all = getAllChars();
            currentQuizChar = all[Math.floor(Math.random() * all.length)];
            document.getElementById('quizQuestion').textContent = currentQuizChar.romaji;
            document.getElementById('quizAnswer').textContent = currentQuizChar.char;
            document.getElementById('quizAnswer').style.visibility = 'hidden';
            document.getElementById('showAnswerBtn').style.display = 'inline-block';
            if (quizCtx) quizCtx.clearRect(0, 0, quizCanvas.width, quizCanvas.height);
            if (quizGuideCanvas) quizGuideCanvas.style.opacity = '0';
        }
        function drawQuizGuide() {
            if (!quizGuideCtx || !currentQuizChar) return;
            quizGuideCtx.clearRect(0, 0, quizGuideCanvas.width, quizGuideCanvas.height);
            const size = quizGuideCanvas.width * 0.65;
            quizGuideCtx.font = FontManager.getCanvasFont(size);
            quizGuideCtx.fillStyle = '#20c997';
            quizGuideCtx.textAlign = 'center';
            quizGuideCtx.textBaseline = 'middle';
            quizGuideCtx.fillText(currentQuizChar.char, quizGuideCanvas.width / 2, quizGuideCanvas.height / 2);
        }
        function showAnswer() {
            document.getElementById('quizAnswer').style.visibility = 'visible';
            document.getElementById('showAnswerBtn').style.display = 'none';
            drawQuizGuide(); quizGuideCanvas.style.opacity = '0.3';
        }
        function markQuizCorrect() { quizCorrect++; document.getElementById('quizCorrect').textContent = quizCorrect; nextQuiz(); }
        function markQuizWrong() { quizWrong++; document.getElementById('quizWrong').textContent = quizWrong; nextQuiz(); }

        // Events
        canvas.addEventListener('mousedown', startDrawing); 
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); 
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false }); 
        canvas.addEventListener('touchmove', draw, { passive: false }); 
        canvas.addEventListener('touchend', stopDrawing);
        window.addEventListener('resize', () => { const w = showGuide; initCanvas(); showGuide = w; guideCanvas.style.opacity = showGuide ? '0.3' : '0'; });

        // Init
        async function init() {
            await FontManager.preloadFonts();
            setupFontOptions();
            FontManager.loadSavedFont();
            initCanvas();
            updateDisplay();
        }
        init();
		
		window.onclick = function(event) {
			const fontModal = document.getElementById('fontModal');
			const chartModal = document.getElementById('chartModal');
			const quizModal = document.getElementById('quizModal');

			if (event.target == fontModal) {
				closeFontSelector();
			} else if (event.target == chartModal) {
				closeChart();
			} else if (event.target == quizModal) {
				closeQuiz();
			}
		}
    </script>
</body>
</html>
